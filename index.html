<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustainable Eateries</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">

    <style>
        body { font-family: Arial, sans-serif; padding-top: 20px; }
        #mymap { height: 600px; width: 100%; border: 1px solid #ccc; border-radius: 4px; }
        .header-img { width: 100%; max-width: 800px; display: block; margin: 0 auto; }
        .well { background: #f5f5f5; border: 1px solid #e3e3e3; }
        .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
    </style>
    
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>

<div class="container-fluid">
    <div class="text-center">
        <h1>Sustainable Eateries</h1>
        <h3>A crowdsourced database to capture how eco-friendly eateries are around the globe</h3>
        <img src="sustainable_eateries.png" alt="Sustainable Eateries" class="header-img">
    </div>
    <br>

    <div class="row">
        <div class="col-sm-4">
            <div class="well">
                <h4>How sustainable was the eatery you visited?</h4>
                
                <div class="form-group">
                    <label>Enter Eatery Name:</label>
                    <input type="text" class="form-control" id="EateryAddress" placeholder="Start typing address...">
                </div>

                <div class="form-group">
                    <label>Choose a rating:</label>
                    <div class="radio"><label><input type="radio" name="rating" value="0"> 0: All single-use plastics</label></div>
                    <div class="radio"><label><input type="radio" name="rating" value="1"> 1: Mix single-use + natural</label></div>
                    <div class="radio"><label><input type="radio" name="rating" value="2"> 2: All natural disposables</label></div>
                    <div class="radio"><label><input type="radio" name="rating" value="3"> 3: Dine-in Reusable / Takeaway Plastic</label></div>
                    <div class="radio"><label><input type="radio" name="rating" value="4"> 4: Dine-in Reusable / Takeaway Natural</label></div>
                    <div class="radio"><label><input type="radio" name="rating" value="5"> 5: Zero Waste + Composting</label></div>
                </div>

                <div class="alert alert-info" style="font-size: 0.9em; padding: 10px;">
                    <strong>Info:</strong> Natural disposables are made from materials like sugarcane, bamboo, or leaves.
                </div>

                <div class="form-group">
                    <label>Comments:</label>
                    <input type="text" class="form-control" id="Comments" placeholder="Feedback/Suggestions">
                </div>
                <div class="form-group">
                    <label>Email (Optional):</label>
                    <input type="email" class="form-control" id="Email" placeholder="For collaboration">
                </div>

                <div class="g-recaptcha" data-sitekey="6LeS0TQsAAAAAG9AWi_PH53Wr6kd8TLY6soeKk-T"></div>
                <br>

                <button id="submitBtn" class="btn btn-primary btn-block" onclick="submitData()">Submit Entry</button>
                <div id="statusMsg" style="margin-top:10px; font-weight:bold;"></div>
            </div>
        </div>

        <div class="col-sm-8">
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#viz">Data Visualization</a></li>
                <li><a data-toggle="tab" href="#knowmore">I want to know more</a></li>
                <li><a data-toggle="tab" href="#domore">I want to do more</a></li>
            </ul>

            <div class="tab-content">
                <div id="viz" class="tab-pane fade in active">
                    <br>
                    <p>Search the existing data for suggestions or add an entry. ðŸŒ¿</p>
                    <div id="mymap"></div>
                </div>
                <div id="knowmore" class="tab-pane fade">
                    <br><h4>About</h4><p>Details about the project...</p>
                </div>
                <div id="domore" class="tab-pane fade">
                    <br><h4>Action</h4><p>How you can help...</p>
                </div>
            </div>
            
            <br>
            <div id="wcb" class="carbonbadge"></div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
<script src="https://unpkg.com/website-carbon-badges@1.1.1/b.min.js" defer></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaRSuTtnn4Bg1WnAubG1b_gbK91KRAFK4&libraries=places&callback=initAutocomplete" async defer></script>

<script>
    // --- SETTINGS ---
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxh4beD3IFkV1e7CGpQVnuXakUq6sFkcbSiOWR0NGUI8VVRPi_umk0LZCxKUdyWhwBHmg/exec"; 

    // --- 1. PLACES AUTOCOMPLETE ---
    let selectedPlace = {};
    function initAutocomplete() {
        var input = document.getElementById('EateryAddress');
        var autocomplete = new google.maps.places.Autocomplete(input, {types: ['establishment']});
        autocomplete.setFields(['formatted_address', 'geometry', 'name']);
        
        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            if (!place.geometry) return;
            selectedPlace = {
                name: place.name,
                address: place.formatted_address,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };
        });
    }

    // --- 2. SUBMIT DATA (SECURE) ---
    function submitData() {
        const rating = document.querySelector('input[name="rating"]:checked');
        const comments = document.getElementById('Comments').value;
        const email = document.getElementById('Email').value;
        const msg = document.getElementById('statusMsg');
        const btn = document.getElementById('submitBtn');

        // Validation
        if (!selectedPlace.lat || !rating) {
            alert("Please select a valid location from the list and a rating.");
            return;
        }
        
        // Get Recaptcha Token
        const captchaToken = grecaptcha.getResponse();
        if (captchaToken.length === 0) {
            alert("Please verify you are human.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Submitting...";

        const payload = {
            EateryName: selectedPlace.name,
            EateryAddress: selectedPlace.address,
            Lat: selectedPlace.lat,
            Lng: selectedPlace.lng,
            Sustainabilityrating: rating.value,
            Comments: comments,
            Email: email,
            captchaToken: captchaToken // Send token to backend
        };

        fetch(APP_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Standard for GAS
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            msg.innerHTML = '<span class="text-success">Entry added! Refreshing map...</span>';
            setTimeout(() => location.reload(), 2000);
        }).catch(err => {
            console.error(err);
            msg.innerHTML = '<span class="text-danger">Error submitting.</span>';
            btn.disabled = false;
            btn.innerText = "Submit Entry";
        });
    }

    // --- 3. LOAD MAP ---
    var map = L.map('mymap').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var markers = L.markerClusterGroup();

    // Add "Locate Me" Button
    L.Control.Button = L.Control.extend({
        onAdd: function(map) {
            var btn = L.DomUtil.create('button', 'btn btn-default btn-sm');
            btn.innerHTML = '<span class="glyphicon glyphicon-screenshot"></span> Near Me';
            btn.style.margin = "10px";
            btn.onclick = function(){ map.locate({setView: true, maxZoom: 16}); }
            return btn;
        }
    });
    new L.Control.Button({ position: 'topleft' }).addTo(map);

    // Fetch Data
    fetch(APP_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        data.forEach(row => {
            if(row.Lat && row.Lng) {
                // Determine color
                let color = 'red';
                let r = parseFloat(row.MeanSustainabilityrating);
                if(r >= 4) color = 'green';
                else if(r >= 3) color = 'orange';

                let icon = L.AwesomeMarkers.icon({
                    icon: 'cutlery',
                    prefix: 'glyphicon',
                    markerColor: color,
                    iconColor: 'white'
                });

                let marker = L.marker([row.Lat, row.Lng], {icon: icon});
                marker.bindPopup(`<b>${row.EateryName}</b><br>Rating: ${Number(r).toFixed(1)}/5`);
                markers.addLayer(marker);
            }
        });
        map.addLayer(markers);
    })
    .catch(e => console.log("Map Error:", e));

</script>
</body>
</html>